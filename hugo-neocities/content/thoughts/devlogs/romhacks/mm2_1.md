---
title: "Making my Mega Man 2 ROM Hack"
date: 2024-02-03T00:00:00-05:00
draft: true
tags:
- devlog
- mega-man
- romhack
---

### Introduction

A couple years back I decided to try my hand at making a romhack, something I've always had a passive interest in. I had a cursory knowledge of assembly code from college going in, but the complexity of romhacking always felt a bit too intimidating for me. Naturally, for a newcomer like me the best approach was to take a simple, easily digestible game to begin with.

I did not do that. Instead, I decided to look at Mega Man 2, a fairly involved game that's been a part of my life almost as long as I can remember. I figured that a good starting point would be to implement a feature from later Mega Man games that the NES run of games always sorely lacked, the Energy Balancer.

![An example of the Energy Balancer in Mega Man X.](../energy_balancer_demo.gif)

In the GIF above, you can see how it works in Mega Man X. If you pick up an energy refill while your default weapon is equipped, it automatically sends that refill towards the least-filled weapon you have unlocked, without making the player wait for the bar to refill. (The same happens if you pick up an energy refill while using a non-default weapon with full energy).

In the NES games, however, the energy refill is simply wasted if the weapon currently equipped does not need it. So, I decided to change that.

---

### Step 1: Research

Now that I had my goal in mind, it was time to start researching the game. Admittedly a good amount of my knowledge was based on sources like the [Data Crystal page](https://datacrystal.tcrf.net/wiki/Mega_Man_2) on Mega Man 2, as well as a healthy amount of my own research.

The function which handles the logic for collecting items exists at ``$82D5``, and looks something like this (labels and comments added by me):

```asm
CollectItem:
$82D5   SEC
$82D6   LDA $AD                  ;Get item ID
$82D8   SBC #$76                 ;Subtract offset of #$76 from item ID
$82DA   TAY                      ;Transfer item ID to Y for indexing
$82DB   LDA #$00
$82DD   STA $AD                  ;Clear out collected item address
$82DF   LDA ItemSubroutineAddressesLow,Y
$82E2   STA $08
$82E4   LDA ItemSubroutineAddressesHigh,Y
$82E7   STA $09
$82E9   JMP ($0008)              ;Execute subroutine for item
```

The ID of the collected item is found at address `$AD`, and `$76` is subtracted to convert the ID into an offset for a pair of address lookup tables. After getting the ID, we clear out `$AD` again by writing 0 to it.

Then we look up a 2-byte address from the tables `ItemSubroutineAddressesLow` and `ItemSubroutineAddressesHigh`, found at `$84DC` and `$84E5` respectively.

```
ItemSubroutineAddressesLow:  EC F0 27 2B 6F 7D 8B 23 A3
ItemSubroutineAddressesHigh: 82 82 83 83 83 83 83 84 84
```

Those addresses are then stored at `$08` and `$09`, and then we jump to the appropriate statement with the command `JMP ($0008)`.

This is the code which handles the two ammo refill items:

```asm
CollectItemAmmoLarge:
$8327   LDA #$0A
$8329   BNE CollectItemAmmo

CollectItemAmmoSmall:
$832B   LDA #$02

CollectItemAmmo:
$832D   STA $FD
$832F   LDA EquippedWeapon
$8331   BEQ DoneCollecting
$8333   LDX EquippedWeapon
$8335   LDA UnlockedItems,X
$8337   CMP #$1C
$8339   BEQ DoneCollecting

$833B   LDA #$07
$833D   STA $AA
$833F   LDX EquippedWeapon
$8341   LDA UnlockedItems,X
$8343   CMP #$1C
$8345   BCS AlreadyFull
$8347   LDA $1C
$8349   AND #$07
$834B   BNE AlreadyFull
$834D   DEC $FD
$834F   BMI AlreadyFull

$8351   INC UnlockedItems,X
$8353   LDA #$28
$8355   JSR PlaySound
$8358   JSR $CC77
$835B   JSR $C07F
$835E   JMP $833F

AlreadyFull:
$8361   LDA #$00
$8363   STA $FD
$8365   STA $AA
$8367   LDA #$03
$8369   STA $2C
$836B   JSR $D3A8

DoneCollecting:
$836E   RTS
```